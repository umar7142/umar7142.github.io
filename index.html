<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AquaTrack | Marine OSINT by Umer Asif</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* üåä MARINE THEME & ANIMATIONS */
        :root {
            --bg-body: #020617; --bg-panel: #0f172a; --text-main: #f8fafc; --text-muted: #94a3b8;
            --accent-blue: #0ea5e9; --accent-gold: #f59e0b; --accent-green: #10b981; --accent-red: #ef4444; --border-color: #1e293b;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); } }

        body { margin: 0; padding: 0; background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* üîù TOP NAVIGATION */
        header { display: flex; align-items: center; justify-content: space-between; padding: 12px 30px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 1000; }
        
        .brand-container { display: flex; align-items: center; gap: 12px; }
        .custom-logo { width: 36px; height: 36px; position: relative; display: flex; align-items: center; justify-content: center; background: rgba(14, 165, 233, 0.1); border-radius: 8px; border: 1px solid var(--accent-blue); }
        .custom-logo i { font-size: 20px; color: var(--accent-blue); }
        
        header h1 { margin: 0; font-size: 22px; font-weight: 700; letter-spacing: -0.5px; display: flex; align-items: center;}
        
        .nav-tabs { display: flex; gap: 20px; }
        .nav-tab { background: transparent; border: none; color: var(--text-muted); font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.3s; padding: 8px 15px; border-radius: 8px; font-family: 'Inter', sans-serif; }
        .nav-tab:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .nav-tab.active { color: var(--accent-blue); background: rgba(14, 165, 233, 0.1); }

        .system-status { display: flex; gap: 15px; font-size: 13px; font-weight: 600; color: var(--text-muted); align-items: center; }
        .live-dot { border-radius: 50%; width: 10px; height: 10px; display: inline-block; background: var(--accent-blue); animation: pulse 2s infinite; }

        /* üóÇÔ∏è VIEWS CONTROLLER */
        .view-section { display: none; flex: 1; overflow: hidden; animation: fadeIn 0.4s ease-out forwards; }
        .view-section.active { display: flex; }

        /* --- üåç RADAR VIEW --- */
        #radar-view { padding: 20px; gap: 20px; }
        .sidebar { width: 340px; background-color: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); overflow: hidden; flex-shrink: 0; }
        .sidebar-title { margin: 0; font-size: 13px; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 1px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background-color: rgba(14, 165, 233, 0.05); border-left: 3px solid var(--accent-blue); padding: 12px; border-radius: 8px; transition: 0.3s; }
        .stat-card.tanker-stats { border-left-color: var(--accent-gold); }
        .stat-card h3 { margin: 0; font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .stat-card p { margin: 5px 0 0 0; font-size: 20px; font-weight: 700; color: var(--text-main); }

        .search-box { display: flex; align-items: center; background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; }
        .search-box input { background: transparent; border: none; color: var(--text-main); font-size: 13px; width: 100%; outline: none; margin-left: 10px; }

        .live-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; padding-right: 5px; }
        .live-list::-webkit-scrollbar { width: 5px; }
        .live-list::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .live-list li { padding: 12px; background-color: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; font-size: 13px; cursor: pointer; border-left: 3px solid transparent; transition: 0.2s; }
        .live-list li:hover { border-color: var(--accent-blue); background: rgba(14, 165, 233, 0.05); }
        .live-list li .ship-id { color: var(--accent-blue); font-weight: 700; font-size: 14px;}

        #map { flex: 1; border: 1px solid var(--border-color); border-radius: 12px; z-index: 1; background: #020617; }
        .leaflet-marker-icon { outline: none !important; border: none !important; background: transparent !important; }
        
        /* THE SHIP ICON */
        .real-ship-icon { display: flex; align-items: center; justify-content: center; background: var(--bg-panel); border: 2px solid var(--accent-blue); border-radius: 50%; color: var(--accent-blue); width: 26px; height: 26px; font-size: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.8); transition: transform 0.5s linear; }
        .real-ship-icon.tanker { border-color: var(--accent-gold); color: var(--accent-gold); }

        /* POPUP & TAGS */
        .leaflet-popup-content-wrapper { background-color: #0f172a; color: #f8fafc; border: 1px solid #1e293b; border-radius: 8px; font-family: 'Inter', sans-serif; box-shadow: 0 10px 25px rgba(0,0,0,0.8); }
        .leaflet-popup-tip { background-color: #0f172a; border: 1px solid #1e293b; border-top: none; border-left: none; }
        .popup-header { display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #1e293b; padding-bottom: 8px; margin-bottom: 8px; }
        .popup-header i { color: #0ea5e9; font-size: 18px; }
        .tag { background: rgba(14, 165, 233, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; color: #38bdf8; border: 1px solid rgba(14, 165, 233, 0.5); }
        .tag.tanker { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border-color: rgba(245, 158, 11, 0.5); }

        /* --- üë§ ABOUT & CONTACT VIEWS --- */
        .content-box { background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px; padding: 40px; max-width: 600px; width: 100%; margin: 40px auto; text-align: center; }
        .content-box img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-blue); margin-bottom: 20px; }
        .content-box h2 { margin: 0 0 10px 0; font-size: 24px; color: #fff; text-transform: uppercase; letter-spacing: 1px;}
        .content-box p { color: var(--text-muted); font-size: 15px; line-height: 1.6; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-muted); }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; color: #fff; font-family: 'Inter'; outline: none; box-sizing: border-box; }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--accent-blue); }
        .submit-btn { background: var(--accent-blue); color: #fff; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; width: 100%; margin-top: 10px; }
        .submit-btn:hover { background: #0284c7; transform: translateY(-2px); }

        /* üì± MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            header { flex-direction: column; padding: 15px; gap: 15px; }
            .nav-tabs { width: 100%; justify-content: center; flex-wrap: wrap; gap: 5px; }
            .nav-tab { flex: 1; text-align: center; font-size: 12px; padding: 10px 5px; }
            .system-status { display: none; } 
            #radar-view { flex-direction: column; padding: 10px; overflow-y: auto; }
            #map { height: 50vh; width: 100%; flex: none; border-radius: 8px; }
            .sidebar { width: 100%; flex: none; height: auto; padding: 15px; box-sizing: border-box; }
            .live-list { height: 350px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand-container">
            <div class="custom-logo">
                <i class="fa-solid fa-ship"></i>
            </div>
            <h1>AQUATRACK <span style="font-weight: 400; color: var(--text-muted); font-size: 16px; margin-left: 8px;">| MARINE OSINT</span></h1>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('radar')"><i class="fa-solid fa-satellite-dish"></i> Live Vessels</button>
            <button class="nav-tab" onclick="switchTab('about')"><i class="fa-solid fa-user-astronaut"></i> About</button>
            <button class="nav-tab" onclick="switchTab('contact')"><i class="fa-solid fa-envelope"></i> Contact</button>
        </div>

        <div class="system-status">
            <div class="live-dot" id="dot-anim"></div>
            <span id="api-text">Booting Sonar System...</span>
            <span id="db-status" style="margin-left: 15px; color: #ef4444;"><i class="fa-solid fa-database"></i> DB Offline</span>
        </div>
    </header>

    <div id="radar-view" class="view-section active">
        <div class="sidebar">
            <h2 class="sidebar-title"><i class="fa-solid fa-chart-pie"></i> Marine Traffic Analytics</h2>
            <div class="stat-grid">
                <div class="stat-card"><h3>Cargo / General</h3><p id="cargo-count">0</p></div>
                <div class="stat-card tanker-stats"><h3>Oil Tankers</h3><p id="tanker-count">0</p></div>
            </div>
            
            <div class="search-box" style="margin-top: 10px;">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="ship-search" placeholder="Search MMSI or Ship Name...">
            </div>

            <ul class="live-list" id="ship-feed"></ul>
        </div>
        <div id="map"></div>
    </div>

    <div id="about-view" class="view-section" style="display: none;">
        <div class="content-box">
            <img src="https://ui-avatars.com/api/?name=Umer+Asif&background=0ea5e9&color=fff&size=128" alt="CEO Umer Asif">
            <h2>UMER ASIF</h2>
            <p style="color: var(--accent-blue); font-weight: 600; margin-top: -5px;">Tech CEO & OSINT Architect</p>
            <p>Welcome to AquaTrack Marine OSINT. This system intercepts live Automatic Identification System (AIS) broadcasts from vessels traversing the global oceans. From airplanes to trains, and now to multi-million dollar Cargo Ships and Oil Tankers. We track everything.</p>
        </div>
    </div>

    <div id="contact-view" class="view-section" style="display: none;">
        <div class="content-box">
            <h2>Secure Transmission</h2>
            <p>Looking to deploy a private marine tracking server? Send a transmission below.</p>
            <form id="contact-form" onsubmit="window.submitContactForm(event)">
                <div class="form-group"><label>Your Identity</label><input type="text" id="contact-name" placeholder="John Doe" required></div>
                <div class="form-group"><label>Email Frequency</label><input type="email" id="contact-email" placeholder="john@company.com" required></div>
                <div class="form-group"><label>Transmission Message</label><textarea id="contact-msg" rows="4" placeholder="Let's build something..." required></textarea></div>
                <button type="submit" class="submit-btn" id="submit-btn"><i class="fa-solid fa-paper-plane" style="margin-right: 8px;"></i> <span id="submit-text">Send Message</span></button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDy07Y1jTioK57WQnULCfB1cZvlR_P3j8A",
            authDomain: "hacking-solutions.firebaseapp.com",
            databaseURL: "https://hacking-solutions-default-rtdb.firebaseio.com",
            projectId: "hacking-solutions",
            storageBucket: "hacking-solutions.firebasestorage.app",
            messagingSenderId: "1074731011147",
            appId: "1:1074731011147:web:c27d725780fc9e0848d1ce"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            document.getElementById("db-status").style.color = "#10b981";
            document.getElementById("db-status").innerHTML = `<i class="fa-solid fa-database"></i> DB Connected`;
            
            window.saveStatsToDatabase = function(cargo, tanker) {
                if (cargo > 0 || tanker > 0) { push(ref(db, 'AquaTrack_Analytics'), { timestamp: new Date().toISOString(), cargo_ships: cargo, oil_tankers: tanker }); }
            };

            window.submitContactForm = async function(event) {
                event.preventDefault();
                const btnText = document.getElementById('submit-text');
                btnText.innerText = "Transmitting...";
                const name = document.getElementById('contact-name').value;
                const email = document.getElementById('contact-email').value;
                const msg = document.getElementById('contact-msg').value;

                try {
                    await push(ref(db, 'Client_Messages'), { name: name, email: email, message: msg, timestamp: new Date().toISOString() });
                    alert("Message successfully sent to Umer Asif's Database!");
                    document.getElementById('contact-form').reset();
                } catch(error) { alert("Error: " + error.message); }
                btnText.innerText = "Send Message";
            };

        } catch (error) { 
            console.error("Firebase Error:", error);
            window.saveStatsToDatabase = function() {}; 
        }
    </script>
    
    <script>
        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(view => view.style.display = 'none');
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`${tabId}-view`).style.display = 'flex';
            event.currentTarget.classList.add('active');
            if(tabId === 'radar') { setTimeout(() => { map.invalidateSize(); }, 100); }
        }

        // BALTIC SEA / GULF OF FINLAND (Huge Marine Traffic Hub)
        var map = L.map('map').setView([59.50, 23.50], 7); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
        
        var shipLayer = L.layerGroup().addTo(map);
        var wakeLayer = L.layerGroup().addTo(map); 

        function getShipIcon(heading, isTanker) {
            let colorClass = isTanker ? 'tanker' : '';
            return L.divIcon({ 
                html: `<div class="real-ship-icon ${colorClass}" style="transform: rotate(${heading}deg);"><i class="fa-solid fa-ship"></i></div>`, 
                className: '', 
                iconSize: [26, 26], 
                iconAnchor: [13, 13], 
                popupAnchor: [0, -13] 
            });
        }

        let activeMarkers = {};
        let shipMetadataCache = {}; 

        document.getElementById('ship-search').addEventListener('input', function(e) {
            let searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#ship-feed li').forEach(li => {
                li.style.display = li.innerText.toLowerCase().includes(searchTerm) ? 'block' : 'none';
            });
        });

        // üö® PRE-FETCH SHIP METADATA
        async function fetchShipMetadata() {
            try {
                let res = await fetch('https://meri.digitraffic.fi/api/ais/v1/vessels');
                let data = await res.json();
                data.forEach(ship => {
                    shipMetadataCache[ship.mmsi] = {
                        name: ship.name || "Unknown Vessel",
                        type: ship.shipType || 0
                    };
                });
            } catch(e) { console.log("Metadata fetch failed."); }
        }

        // üö® MAIN RADAR ENGINE
        async function fetchLiveShips() {
            try {
                document.getElementById("api-text").innerText = "Scanning Ocean AIS...";
                document.getElementById("dot-anim").style.background = "#0ea5e9";

                let response = await fetch('https://meri.digitraffic.fi/api/ais/v1/locations');
                if(!response.ok) throw new Error("API Down");
                
                let rawData = await response.json();
                
                // üõë HACKER FIX: JSON Feature Box Open Kiya Hai Yahan üõë
                let shipsData = rawData.features || rawData;
                
                const feedContainer = document.getElementById('ship-feed');
                feedContainer.innerHTML = ''; 
                let cargoCount = 0; let tankerCount = 0;
                let currentShipIDs = new Set(); 
                
                let currentBounds = map.getBounds();
                
                // Limit to 500 ships at a time to keep browser super fast
                let loopLimit = Math.min(shipsData.length, 500);

                for (let i = 0; i < loopLimit; i++) {
                    let ship = shipsData[i];
                    if(!ship.geometry || !ship.geometry.coordinates) continue;

                    let lon = ship.geometry.coordinates[0];
                    let lat = ship.geometry.coordinates[1];
                    
                    // üõë HACKER FIX: MMSI ID dhoondhne ka sahi rasta
                    let mmsi = ship.properties ? ship.properties.mmsi : ship.mmsi;
                    if(!mmsi) continue;
                    
                    // Only process ships currently visible on screen
                    if(!currentBounds.contains([lat, lon])) continue;

                    currentShipIDs.add(mmsi);

                    let meta = shipMetadataCache[mmsi] || { name: `MMSI: ${mmsi}`, type: 0 };
                    let shipName = meta.name;
                    
                    let isTanker = (meta.type >= 80 && meta.type < 90);
                    let shipTypeName = isTanker ? "Oil/Chemical Tanker" : "Cargo / Gen Vessel";
                    
                    if(isTanker) tankerCount++; else cargoCount++;

                    let speed = ship.properties ? (ship.properties.sog || 0) : 0; 
                    let heading = ship.properties ? (ship.properties.heading || ship.properties.cog || 0) : 0; 

                    let typeTag = isTanker ? '<span class="tag tanker">OIL TANKER</span>' : '<span class="tag">CARGO VESSEL</span>';
                    
                    let popupHTML = `
                        <div class="popup-header"><i class="fa-solid fa-ship" style="color: ${isTanker ? '#f59e0b' : '#0ea5e9'};"></i><div class="popup-title">${shipName}</div></div>
                        <div style="margin-bottom: 10px;">${typeTag}</div>
                        <div class="popup-info"><b>MMSI ID:</b> ${mmsi}</div>
                        <div class="popup-info"><b>Speed:</b> ${speed} Knots</div>
                        <div class="popup-info"><b>Heading:</b> ${heading}¬∞</div>
                    `;

                    // MAP DRAWING
                    if(activeMarkers[mmsi]) {
                        activeMarkers[mmsi].marker.setLatLng([lat, lon]);
                        activeMarkers[mmsi].marker.setIcon(getShipIcon(heading, isTanker));
                        activeMarkers[mmsi].marker.setPopupContent(popupHTML);
                        
                        activeMarkers[mmsi].trailHistory.push([lat, lon]);
                        if(activeMarkers[mmsi].trailHistory.length > 20) activeMarkers[mmsi].trailHistory.shift();
                        
                        activeMarkers[mmsi].trailLine.setLatLngs(activeMarkers[mmsi].trailHistory);

                    } else {
                        let marker = L.marker([lat, lon], { icon: getShipIcon(heading, isTanker) }).bindPopup(popupHTML);
                        shipLayer.addLayer(marker);
                        
                        let trailColor = isTanker ? '#f59e0b' : '#0ea5e9';
                        let trailLine = L.polyline([[lat, lon]], { 
                            color: trailColor, 
                            weight: 3, 
                            opacity: 0.6, 
                            dashArray: '2, 6' 
                        }).addTo(wakeLayer);
                        
                        activeMarkers[mmsi] = { marker: marker, trailHistory: [[lat, lon]], trailLine: trailLine };
                    }

                    // Add to Sidebar
                    let listItem = document.createElement('li');
                    let listText = `${shipName} ${mmsi}`.toLowerCase();
                    if(document.getElementById('ship-search').value !== "" && !listText.includes(document.getElementById('ship-search').value.toLowerCase())) { listItem.style.display = 'none'; }

                    let sidebarIconColor = isTanker ? "color: var(--accent-gold);" : "color: var(--accent-blue);";
                    listItem.innerHTML = `
                        <div class="ship-id" style="${sidebarIconColor}"><i class="fa-solid fa-anchor" style="font-size:12px; margin-right:5px;"></i> ${shipName}</div>
                        <div class="airline-name">${shipTypeName}</div>
                        <div class="flight-route">MMSI: ${mmsi} | ${speed} Knots</div>
                    `;
                    listItem.onclick = () => { map.flyTo([lat, lon], 12); activeMarkers[mmsi].marker.openPopup(); };
                    feedContainer.appendChild(listItem);
                }

                // Cleanup old ships
                for (let mmsi in activeMarkers) {
                    if (!currentShipIDs.has(parseInt(mmsi))) {
                        shipLayer.removeLayer(activeMarkers[mmsi].marker);
                        wakeLayer.removeLayer(activeMarkers[mmsi].trailLine);
                        delete activeMarkers[mmsi];
                    }
                }

                document.getElementById('cargo-count').innerText = cargoCount;
                document.getElementById('tanker-count').innerText = tankerCount;
                
                document.getElementById("api-text").innerText = `Live: Nordic Marine AIS`;
                document.getElementById("dot-anim").style.background = "#10b981"; 

                if(window.saveStatsToDatabase) { window.saveStatsToDatabase(cargoCount, tankerCount); }

            } catch (error) {
                console.error(error);
                document.getElementById("api-text").innerText = "Sonar Jammed... Retrying.";
                document.getElementById("dot-anim").style.background = "#ef4444"; 
            }
        }

        // Initialize
        fetchShipMetadata().then(() => {
            fetchLiveShips();
            map.on('moveend', fetchLiveShips); 
            setInterval(fetchLiveShips, 20000); 
        });

    </script>
</body>
</html>
